name: ğŸš€ è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬

on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é…ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v1.0.0, v2.1.3

env:
  WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
  WEBDAV_USERNAME: ${{ secrets.WEBDAV_USERNAME }}
  WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}

jobs:
  release:
    name: ğŸ“¦ æ„å»ºå’Œå‘å¸ƒ
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç”Ÿæˆå˜æ›´æ—¥å¿—

      - name: ğŸŸ¢ è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ” éªŒè¯é¡¹ç›®å®Œæ•´æ€§
        run: |
          echo "ğŸ“‹ æ£€æŸ¥å…³é”®æ–‡ä»¶..."
          ls -la
          echo "âœ… package.jsonå­˜åœ¨" && test -f package.json
          echo "âœ… index.jså­˜åœ¨" && test -f index.js
          echo "âœ… config.jså­˜åœ¨" && test -f config.js
          echo "âœ… README.mdå­˜åœ¨" && test -f README.md

      - name: ğŸ“ æå–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "clean_version=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ å‘å¸ƒç‰ˆæœ¬: $VERSION"

      - name: ğŸ“ ç”Ÿæˆå˜æ›´æ—¥å¿—
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            echo "ä»CHANGELOG.mdæå–å˜æ›´ä¿¡æ¯..."
            # æå–å½“å‰ç‰ˆæœ¬çš„å˜æ›´å†…å®¹
            awk '/^## \['${{ steps.version.outputs.clean_version }}'\]/{flag=1; next} /^## \[/{flag=0} flag' CHANGELOG.md > current_changelog.txt
            if [ -s current_changelog.txt ]; then
              echo "changelog_content<<EOF" >> $GITHUB_OUTPUT
              cat current_changelog.txt >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "changelog_content=ğŸ‰ ç‰ˆæœ¬ ${{ steps.version.outputs.version }} å‘å¸ƒï¼" >> $GITHUB_OUTPUT
            fi
          else
            echo "changelog_content=ğŸ‰ ç‰ˆæœ¬ ${{ steps.version.outputs.version }} å‘å¸ƒï¼æŸ¥çœ‹ä»£ç è·å–æœ€æ–°åŠŸèƒ½ã€‚" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¦ åˆ›å»ºå‘å¸ƒåŒ…
        run: |
          echo "ğŸ—‚ï¸ å‡†å¤‡å‘å¸ƒæ–‡ä»¶..."
          
          # åˆ›å»ºä¸´æ—¶æ‰“åŒ…ç›®å½•
          mkdir -p release-temp/danmu2rcon-${{ steps.version.outputs.clean_version }}
          
          # å¤åˆ¶æ ¸å¿ƒè¿è¡Œæ–‡ä»¶
          echo "ğŸ“‹ å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶..."
          cp -v \
            index.js \
            rcon-client.js \
            danmu-listener.js \
            event-bridge-server.js \
            config.js \
            package.json \
            package-lock.json \
            README.md \
            LICENSE \
            CONTRIBUTING.md \
            CHANGELOG.md \
            favicon.ico \
            release-temp/danmu2rcon-${{ steps.version.outputs.clean_version }}/
          
          # å¤åˆ¶publicç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -d "public" ]; then
            echo "ğŸ“ å¤åˆ¶publicç›®å½•..."
            cp -r public release-temp/danmu2rcon-${{ steps.version.outputs.clean_version }}/
          fi
          
          # æ˜¾ç¤ºæ’é™¤çš„å¼€å‘æ–‡ä»¶
          echo "ğŸš« ä»¥ä¸‹å¼€å‘æ–‡ä»¶å°†è¢«æ’é™¤åœ¨å‘å¸ƒåŒ…ä¹‹å¤–:"
          echo "   - create-tag.bat (ç‰ˆæœ¬æ ‡ç­¾åˆ›å»ºè„šæœ¬)"
          echo "   - docs/RELEASE.md (å‘å¸ƒå·¥ä½œæµæ–‡æ¡£)"
          echo "   - .github/ (GitHub Actionså·¥ä½œæµ)"
          echo "   - .git/ (Gitç‰ˆæœ¬æ§åˆ¶ç›®å½•)"
          echo "   - node_modules/ (ä¾èµ–åŒ…ï¼Œå°†é‡æ–°å®‰è£…ç”Ÿäº§ç‰ˆæœ¬)"
          
          # è¿›å…¥æ‰“åŒ…ç›®å½•
          cd release-temp
          
          # åˆ›å»ºå®Œæ•´ç‰ˆæœ¬ï¼ˆåŒ…å«ä¾èµ–ï¼‰
          echo "ğŸ“¦ åˆ›å»ºå®Œæ•´ç‰ˆæœ¬ï¼ˆåŒ…å«node_modulesï¼‰..."
          cd danmu2rcon-${{ steps.version.outputs.clean_version }}
          npm ci --production --silent
          cd ..
          zip -r ../danmu2rcon-${{ steps.version.outputs.clean_version }}-full.zip danmu2rcon-${{ steps.version.outputs.clean_version }}
          
          # åˆ›å»ºæºç ç‰ˆæœ¬ï¼ˆä¸åŒ…å«ä¾èµ–ï¼‰
          echo "ğŸ“¦ åˆ›å»ºæºç ç‰ˆæœ¬..."
          rm -rf danmu2rcon-${{ steps.version.outputs.clean_version }}/node_modules
          zip -r ../danmu2rcon-${{ steps.version.outputs.clean_version }}-source.zip danmu2rcon-${{ steps.version.outputs.clean_version }}
          
          # å›åˆ°æ ¹ç›®å½•
          cd ..
          
          # éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
          echo "âœ… ç”Ÿæˆçš„å‘å¸ƒåŒ…ï¼š"
          ls -lh *.zip
          
          # æ˜¾ç¤ºå‘å¸ƒåŒ…å†…å®¹æ‘˜è¦
          echo ""
          echo "ğŸ“¦ å‘å¸ƒåŒ…å†…å®¹æ‘˜è¦ï¼š"
          unzip -l danmu2rcon-${{ steps.version.outputs.clean_version }}-source.zip | head -20

      - name: ğŸ¯ åˆ›å»º GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          release_name: ğŸ® Danmu2RCON ${{ steps.version.outputs.version }}
          body: |
            ## ğŸ‰ ç‰ˆæœ¬ ${{ steps.version.outputs.version }} å‘å¸ƒ

            ### ğŸ“¥ ä¸‹è½½é€‰é¡¹
            - **å®Œæ•´ç‰ˆæœ¬** (`danmu2rcon-${{ steps.version.outputs.clean_version }}-full.zip`): åŒ…å«æ‰€æœ‰ä¾èµ–ï¼Œä¸‹è½½å³ç”¨
            - **æºç ç‰ˆæœ¬** (`danmu2rcon-${{ steps.version.outputs.clean_version }}-source.zip`): ä»…æºç ï¼Œéœ€è¦è¿è¡Œ `npm install`

            ### ğŸš€ å¿«é€Ÿå¼€å§‹
            1. ä¸‹è½½å®Œæ•´ç‰ˆæœ¬
            2. è§£å‹åˆ°ä»»æ„ç›®å½•
            3. è¿è¡Œ `node index.js`
            4. è®¿é—® http://localhost:3000 è¿›è¡Œé…ç½®

            ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
            - Node.js 16.0+
            - MinecraftæœåŠ¡å™¨ï¼ˆå¼€å¯RCONï¼‰
            - LAPLACE Chatå¼¹å¹•å®¢æˆ·ç«¯

            ### ğŸ”„ å˜æ›´å†…å®¹
            ${{ steps.changelog.outputs.changelog_content }}

            ### ğŸ“ æŠ€æœ¯æ”¯æŒ
            - ğŸ“š ä½¿ç”¨æ–‡æ¡£ï¼šæŸ¥çœ‹é¡¹ç›®README
            - ğŸ› é—®é¢˜åé¦ˆï¼š[GitHub Issues](https://github.com/${{ github.repository }}/issues)
            - ğŸ“§ è”ç³»ä½œè€…ï¼šWittF@qq.com

            ---
            â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ªæ˜Ÿæ ‡æ”¯æŒï¼
          draft: false
          prerelease: false

      - name: â¬†ï¸ ä¸Šä¼ å®Œæ•´ç‰ˆæœ¬åˆ° Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./danmu2rcon-${{ steps.version.outputs.clean_version }}-full.zip
          asset_name: danmu2rcon-${{ steps.version.outputs.clean_version }}-full.zip
          asset_content_type: application/zip

      - name: â¬†ï¸ ä¸Šä¼ æºç ç‰ˆæœ¬åˆ° Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./danmu2rcon-${{ steps.version.outputs.clean_version }}-source.zip
          asset_name: danmu2rcon-${{ steps.version.outputs.clean_version }}-source.zip
          asset_content_type: application/zip

      - name: ğŸŒ ä¸Šä¼ åˆ° WebDAV æœåŠ¡å™¨
        if: env.WEBDAV_URL != ''
        run: |
          echo "ğŸŒ å¼€å§‹ä¸Šä¼ åˆ°WebDAVæœåŠ¡å™¨..."
          
          # å®‰è£…curlï¼ˆå¦‚æœéœ€è¦ï¼‰
          sudo apt-get update && sudo apt-get install -y curl
          
          # åˆ›å»ºWebDAVç›®å½•
          WEBDAV_DIR="danmu2rcon/releases/${{ steps.version.outputs.version }}"
          
          echo "ğŸ“ åˆ›å»ºè¿œç¨‹ç›®å½•: $WEBDAV_DIR"
          curl -X MKCOL \
            -u "$WEBDAV_USERNAME:$WEBDAV_PASSWORD" \
            "$WEBDAV_URL/danmu2rcon/" || true
          
          curl -X MKCOL \
            -u "$WEBDAV_USERNAME:$WEBDAV_PASSWORD" \
            "$WEBDAV_URL/danmu2rcon/releases/" || true
          
          curl -X MKCOL \
            -u "$WEBDAV_USERNAME:$WEBDAV_PASSWORD" \
            "$WEBDAV_URL/$WEBDAV_DIR/" || true
          
          # ä¸Šä¼ å®Œæ•´ç‰ˆæœ¬
          echo "â¬†ï¸ ä¸Šä¼ å®Œæ•´ç‰ˆæœ¬..."
          curl -T "danmu2rcon-${{ steps.version.outputs.clean_version }}-full.zip" \
            -u "$WEBDAV_USERNAME:$WEBDAV_PASSWORD" \
            "$WEBDAV_URL/$WEBDAV_DIR/danmu2rcon-${{ steps.version.outputs.clean_version }}-full.zip"
          
          # ä¸Šä¼ æºç ç‰ˆæœ¬
          echo "â¬†ï¸ ä¸Šä¼ æºç ç‰ˆæœ¬..."
          curl -T "danmu2rcon-${{ steps.version.outputs.clean_version }}-source.zip" \
            -u "$WEBDAV_USERNAME:$WEBDAV_PASSWORD" \
            "$WEBDAV_URL/$WEBDAV_DIR/danmu2rcon-${{ steps.version.outputs.clean_version }}-source.zip"
          
          # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          echo "ğŸ“ åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶..."
          cat > version-info.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "clean_version": "${{ steps.version.outputs.clean_version }}",
            "release_date": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "github_release": "https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}",
            "files": {
              "full": "danmu2rcon-${{ steps.version.outputs.clean_version }}-full.zip",
              "source": "danmu2rcon-${{ steps.version.outputs.clean_version }}-source.zip"
            },
            "requirements": {
              "nodejs": "16.0+",
              "minecraft": "æ”¯æŒRCONçš„ç‰ˆæœ¬",
              "platform": "Windows/Linux/macOS"
            },
            "excluded_files": [
              "create-tag.bat",
              "docs/RELEASE.md",
              ".github/",
              ".git/"
            ]
          }
          EOF
          
          curl -T "version-info.json" \
            -u "$WEBDAV_USERNAME:$WEBDAV_PASSWORD" \
            "$WEBDAV_URL/$WEBDAV_DIR/version-info.json"
          
          # æ›´æ–°æœ€æ–°ç‰ˆæœ¬é“¾æ¥
          echo "ğŸ”— æ›´æ–°æœ€æ–°ç‰ˆæœ¬é“¾æ¥..."
          curl -T "danmu2rcon-${{ steps.version.outputs.clean_version }}-full.zip" \
            -u "$WEBDAV_USERNAME:$WEBDAV_PASSWORD" \
            "$WEBDAV_URL/danmu2rcon/danmu2rcon-latest.zip"
          
          curl -T "version-info.json" \
            -u "$WEBDAV_USERNAME:$WEBDAV_PASSWORD" \
            "$WEBDAV_URL/danmu2rcon/latest-version.json"
          
          echo "âœ… WebDAVä¸Šä¼ å®Œæˆï¼"
          echo "ğŸ“ WebDAVè·¯å¾„: $WEBDAV_URL/$WEBDAV_DIR/"

      - name: ğŸ“Š å‘å¸ƒæ€»ç»“
        run: |
          echo "ğŸ‰ ç‰ˆæœ¬ ${{ steps.version.outputs.version }} å‘å¸ƒå®Œæˆï¼"
          echo ""
          echo "ğŸ“¦ å‘å¸ƒåŒ…ä¿¡æ¯ï¼š"
          ls -lh *.zip
          echo ""
          echo "ğŸ”— ä¸‹è½½é“¾æ¥ï¼š"
          echo "  - GitHub Release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
          if [ -n "$WEBDAV_URL" ]; then
            echo "  - WebDAV: $WEBDAV_URL/danmu2rcon/releases/${{ steps.version.outputs.version }}/"
            echo "  - æœ€æ–°ç‰ˆæœ¬: $WEBDAV_URL/danmu2rcon/danmu2rcon-latest.zip"
          fi
          echo ""
          echo "ğŸš« å·²æ’é™¤çš„å¼€å‘æ–‡ä»¶ï¼š"
          echo "  - create-tag.bat"
          echo "  - docs/RELEASE.md"
          echo "  - .github/"
          echo "  - .git/"
          echo ""
          echo "âœ… å‘å¸ƒæµç¨‹æ‰§è¡ŒæˆåŠŸï¼"

  notify:
    name: ğŸ“¢ å‘å¸ƒé€šçŸ¥
    runs-on: ubuntu-latest
    needs: release
    if: always()
    
    steps:
      - name: ğŸ“ æå–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: âœ… æˆåŠŸé€šçŸ¥
        if: needs.release.result == 'success'
        run: |
          echo "ğŸ‰ å‘å¸ƒæˆåŠŸï¼"
          echo "ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
          echo "çŠ¶æ€: âœ… å·²æˆåŠŸå‘å¸ƒåˆ° GitHub Release å’Œ WebDAV"

      - name: âŒ å¤±è´¥é€šçŸ¥
        if: needs.release.result == 'failure'
        run: |
          echo "âŒ å‘å¸ƒå¤±è´¥ï¼"
          echo "ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
          echo "è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          exit 1 